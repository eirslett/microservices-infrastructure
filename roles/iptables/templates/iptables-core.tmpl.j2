#!/bin/bash
iptables -F CLUSTER
iptables -D INPUT -j CLUSTER
iptables -X CLUSTER
iptables -N CLUSTER


{% raw %}
# Allow all connection within the cluster
{{range nodes}}
iptables -A CLUSTER -s {{.Address}} -j ACCEPT{{end}}
{% endraw %}
iptables -A INPUT -j CLUSTER

iptables -F COMMON
iptables -D INPUT -j COMMON
iptables -X COMMON
iptables -N COMMON

# Allow from docker0
iptables -A COMMON -i docker0 -j ACCEPT

# Allow stateful connections
iptables -A COMMON -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# Allow SSH from all IPs
iptables -A COMMON -p tcp --dport 22 -j ACCEPT

# Allow Consul access (to let new hosts join) but rate limit the connections
iptables -A COMMON -p tcp --dport 8300 -m state --state NEW -m recent --set
iptables -A COMMON -p tcp --dport 8300 -m state --state NEW -m recent --update --seconds 10 --hitcount 20 -j DROP
iptables -A COMMON -p udp --dport 8301 -m state --state NEW -m recent --set
iptables -A COMMON -p udp --dport 8301 -m state --state NEW -m recent --update --seconds 10 --hitcount 20 -j DROP
iptables -A COMMON -p udp --dport 8302 -m state --state NEW -m recent --set
iptables -A COMMON -p udp --dport 8302 -m state --state NEW -m recent --update --seconds 10 --hitcount 20 -j DROP
iptables -A COMMON -p tcp --dport 8400 -m state --state NEW -m recent --set
iptables -A COMMON -p tcp --dport 8400 -m state --state NEW -m recent --update --seconds 10 --hitcount 20 -j DROP


# Allow loopback
iptables -I COMMON 1 -i lo -j ACCEPT

# IP address whitelist
{% for allow_ip in iptables_allow_ips %}
iptables -A COMMON -s {{ allow_ip }} -j ACCEPT
{% endfor %}

# Deny all others (just log for now)
iptables -A COMMON -j LOG
iptables -A COMMON -j DROP

iptables -A INPUT -j COMMON

# Forwarding rules
iptables -F CLUSTER_FORWARD
iptables -D FORWARD -j CLUSTER_FORWARD
iptables -X CLUSTER_FORWARD
iptables -N CLUSTER_FORWARD

# Allow all connection within the cluster
{% raw %}
{{range nodes}}
iptables -A CLUSTER_FORWARD -s {{.Address}} -j ACCEPT{{end}}
{% endraw %}

# Allow stateful connections
iptables -A CLUSTER_FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# IP address whitelist
{% for allow_ip in iptables_allow_ips %}
iptables -A CLUSTER_FORWARD -s {{ allow_ip }} -j ACCEPT
{% endfor %}

iptables -I FORWARD -j CLUSTER_FORWARD

# Finally, after the DOCKER chain, drop the rest
iptables -D FORWARD -j LOG
iptables -A FORWARD -j LOG
iptables -D FORWARD -j DROP
iptables -A FORWARD -j DROP
